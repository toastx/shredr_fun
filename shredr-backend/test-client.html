<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Shredr WebSocket Test Client</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #333;
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 5px;
                font-weight: bold;
            }
            .connected {
                background-color: #d4edda;
                color: #155724;
            }
            .disconnected {
                background-color: #f8d7da;
                color: #721c24;
            }
            .messages {
                margin-top: 20px;
                max-height: 400px;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 10px;
                background-color: #f9f9f9;
            }
            .message {
                padding: 10px;
                margin: 5px 0;
                border-left: 3px solid #007bff;
                background-color: white;
            }
            .message.transaction {
                border-left-color: #28a745;
            }
            .message.status {
                border-left-color: #ffc107;
            }
            .timestamp {
                font-size: 0.8em;
                color: #666;
            }
            button {
                padding: 10px 20px;
                margin: 5px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            }
            .connect-btn {
                background-color: #28a745;
                color: white;
            }
            .disconnect-btn {
                background-color: #dc3545;
                color: white;
            }
            .clear-btn {
                background-color: #6c757d;
                color: white;
            }
            input[type="text"] {
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ðŸ”Œ Shredr WebSocket Test Client</h1>

            <div>
                <label for="wsUrl">WebSocket URL:</label>
                <input
                    type="text"
                    id="wsUrl"
                    value="ws://localhost:8000/ws"
                    placeholder="ws://localhost:8000/ws"
                />
            </div>

            <div>
                <button class="connect-btn" onclick="connect()">Connect</button>
                <button class="disconnect-btn" onclick="disconnect()">
                    Disconnect
                </button>
                <button class="clear-btn" onclick="clearMessages()">
                    Clear Messages
                </button>
            </div>

            <div id="status" class="status disconnected">Disconnected</div>

            <hr style="margin: 20px 0; border: 1px solid #ddd" />

            <h2>Webhook Address Management</h2>
            <div>
                <label for="webhookId">Webhook ID:</label>
                <input
                    type="text"
                    id="webhookId"
                    placeholder="Enter Webhook ID"
                />
            </div>
            <div>
                <label for="addresses">Addresses (comma separated):</label>
                <input
                    type="text"
                    id="addresses"
                    placeholder="Enter wallet addresses"
                />
            </div>
            <div>
                <button
                    onclick="addAddress()"
                    style="background-color: #17a2b8; color: white"
                >
                    Add Addresses
                </button>
                <button
                    onclick="removeAddress()"
                    style="background-color: #dc3545; color: white"
                >
                    Remove Addresses
                </button>
            </div>

            <h2>Messages</h2>
            <div id="messages" class="messages">
                <p style="color: #999">
                    No messages yet. Connect to start receiving messages.
                </p>
            </div>
        </div>

        <script>
            let ws = null;
            let messageCount = 0;
            const API_URL = "http://localhost:8000";

            async function addAddress() {
                const webhookId = document
                    .getElementById("webhookId")
                    .value.trim();
                const addressesStr = document
                    .getElementById("addresses")
                    .value.trim();

                if (!webhookId || !addressesStr) {
                    alert("Please enter both Webhook ID and Addresses");
                    return;
                }

                const addresses = addressesStr
                    .split(",")
                    .map((a) => a.trim())
                    .filter((a) => a);

                try {
                    const response = await fetch(`${API_URL}/webhook/address`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            webhook_id: webhookId,
                            addresses: addresses,
                        }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        addLog(`âœ… Success: ${data.message}`);
                    } else {
                        addLog(`âŒ Error: ${data.message}`);
                    }
                } catch (error) {
                    addLog(`âŒ Network Error: ${error.message}`);
                }
            }

            async function removeAddress() {
                const webhookId = document
                    .getElementById("webhookId")
                    .value.trim();
                const addressesStr = document
                    .getElementById("addresses")
                    .value.trim();

                if (!webhookId || !addressesStr) {
                    alert("Please enter both Webhook ID and Addresses");
                    return;
                }

                const addresses = addressesStr
                    .split(",")
                    .map((a) => a.trim())
                    .filter((a) => a);

                try {
                    const response = await fetch(`${API_URL}/webhook/address`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            webhook_id: webhookId,
                            addresses: addresses,
                        }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        addLog(`âœ… Success: ${data.message}`);
                    } else {
                        addLog(`âŒ Error: ${data.message}`);
                    }
                } catch (error) {
                    addLog(`âŒ Network Error: ${error.message}`);
                }
            }

            function connect() {
                const url = document.getElementById("wsUrl").value;

                if (ws && ws.readyState === WebSocket.OPEN) {
                    addLog("Already connected!");
                    return;
                }

                addLog(`Connecting to ${url}...`);

                ws = new WebSocket(url);

                ws.onopen = () => {
                    updateStatus(true);
                    addLog("Connected successfully!");
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        addMessage(message);
                    } catch (e) {
                        addLog(`Error parsing message: ${e.message}`);
                    }
                };

                ws.onerror = (error) => {
                    addLog(`WebSocket error: ${error}`);
                };

                ws.onclose = () => {
                    updateStatus(false);
                    addLog("Disconnected from server");
                };
            }

            function disconnect() {
                if (ws) {
                    ws.close();
                    ws = null;
                }
            }

            function updateStatus(connected) {
                const statusDiv = document.getElementById("status");
                if (connected) {
                    statusDiv.className = "status connected";
                    statusDiv.textContent = "Connected";
                } else {
                    statusDiv.className = "status disconnected";
                    statusDiv.textContent = "Disconnected";
                }
            }

            function addMessage(message) {
                const messagesDiv = document.getElementById("messages");

                // Clear placeholder text on first message
                if (messageCount === 0) {
                    messagesDiv.innerHTML = "";
                }

                messageCount++;

                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${message.type}`;

                const timestamp = new Date(message.timestamp).toLocaleString();

                let content = "";
                if (message.type === "transaction") {
                    content = `
                    <strong>ðŸ”” Transaction Received</strong>
                    <div class="timestamp">${timestamp}</div>
                    <pre>${JSON.stringify(message.data, null, 2)}</pre>
                `;
                } else if (message.type === "status") {
                    content = `
                    <strong>ðŸ“Š Status Update</strong>
                    <div class="timestamp">${timestamp}</div>
                    <p>Connected clients: ${message.clients_count}</p>
                `;
                } else {
                    content = `
                    <strong>ðŸ“¨ Message</strong>
                    <div class="timestamp">${timestamp}</div>
                    <pre>${JSON.stringify(message, null, 2)}</pre>
                `;
                }

                messageDiv.innerHTML = content;
                messagesDiv.insertBefore(messageDiv, messagesDiv.firstChild);
            }

            function addLog(text) {
                const messagesDiv = document.getElementById("messages");

                if (messageCount === 0) {
                    messagesDiv.innerHTML = "";
                }

                const logDiv = document.createElement("div");
                logDiv.className = "message";
                logDiv.innerHTML = `
                <div class="timestamp">${new Date().toLocaleString()}</div>
                <p>${text}</p>
            `;
                messagesDiv.insertBefore(logDiv, messagesDiv.firstChild);
            }

            function clearMessages() {
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML =
                    '<p style="color: #999;">No messages yet. Connect to start receiving messages.</p>';
                messageCount = 0;
            }

            // Auto-connect on page load (optional)
            // window.onload = connect;
        </script>
    </body>
</html>
